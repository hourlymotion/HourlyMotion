<html>
    <head>
        <script src="https://api.dmcdn.net/all.js"></script>
        <script src="https://connect.facebook.net/en_US/sdk.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            DM.init({
                apiKey: '408218a64170fbdf1498',
                // apiKey: '4fc5ab5c3010407f51cd',
                status: true, // check login status
                cookie: true // enable cookies to allow the server to access the session
            });
            FB.init({
                appId      : '327688984675339',
                cookie     : true,
                xfbml      : true,
                version    : 'v3.2'
            });
            // FB.AppEvents.logPageView(); needed ?
            
            $(document).ready(function(){

            });
            
        </script>
        <link rel="stylesheet" href="hourlymotion.css">
    </head>
    <body>
        <button id='dm-login'>DM Login</button>
        <script>
            DM.getLoginStatus(function(response) {
                if (response.session) {
                    console.log('already logged in', response.session);
                    document.getElementById('dm-login').remove();
                } else {
                    document.getElementById('dm-login').onclick = function() {
                        DM.login(function(response) {
                            if (response.session) {
                                console.log("logged in user", response.session);
                            } else {
                                console.log("login cancelled");
                            }
                        });
                    };
                }
            });
        </script>
        <fb:login-button 
          scope="public_profile,email"
          onlogin="checkLoginState();">
        </fb:login-button>
        <script>
            function checkLoginState() {
              FB.getLoginStatus(function(response) {
                console.log(response);
              }, {scope: 'public_profile,email,user_gender,user_age_range,user_likes,user_location'});
            }
        </script>
        
        <!-- <button id='fb-login'>FB Login</button>
        <script>
            FB.getLoginStatus(function(response) {
                console.log('FB login status', response);
            });
            document.getElementById('fb-login').onclick = function() {
                FB.login(function(response) {
                    console.log('FB login response', response);

                }, {scope: 'public_profile,email,user_gender,user_age_range,user_likes,user_location'});
            };-->

        </script>

        <div id='player'></div>
        <script>
            var player = DM.player(document.getElementById('player'), {
                video: 'xwr14q',
                width: '90%',
                height: '90%',
                params: {
                    autoplay: false,
                    mute: true
                }
            });
            
            var userId;
            
            function getUserId() {
                if (userId == null) {
                    DM.getLoginStatus(function(user) {
                        if (user.session) userId = user.session.uid;
                    });
                }
                
                return userId;
            }

            player.addEventListener('video_start', function(event) {
                console.log("video_start", getUserId());
                fetch('/event', {
                    method: 'POST',
                    body: JSON.stringify({
                        user: {
                            xid: getUserId()
                        },
                        type: event.type,
                        video_id: 'TODO FIXME'
                    })
                }).then(
                    response => response.text()
                ).then(
                    html => console.log(html)
                );
            });
                
            player.addEventListener('video_end', function(event) {
                console.log("video End", getUserId());
                
            });
            
            player.addEventListener('ad_start', function(event) {
                console.log("Ad start");
            });
            
            player.addEventListener('ad_end', function(event) {
                console.log("Ad End");
            });
        </script>
    </body>
</html>